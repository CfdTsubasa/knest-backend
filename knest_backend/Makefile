# =============================================================================
# KnestApp Backend Makefile
# =============================================================================

.PHONY: help install setup migrate reset-db server test clean dev prod

# ä»®æƒ³ç’°å¢ƒã‚’ä½¿ç”¨ï¼ˆå…ƒã®Makefileã¨æ•´åˆæ€§ã‚’ä¿ã¤ï¼‰
VENV := venv
PYTHON := ./$(VENV)/bin/python
PIP := ./$(VENV)/bin/pip
MANAGE := $(PYTHON) manage.py

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼‰
help:
	@echo "ðŸš€ KnestApp Backend Commands"
	@echo "=============================="
	@echo ""
	@echo "ðŸ“¦ Setup & Installation:"
	@echo "  make install      - ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (venvå†…)"
	@echo "  make setup        - åˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆDBä½œæˆãƒ»ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰"
	@echo ""
	@echo "ðŸ—ƒï¸  Database:"
	@echo "  make migrate      - ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"
	@echo "  make makemigrations - ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ"
	@echo "  make reset-db     - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ"
	@echo "  make shell        - Django shellèµ·å‹•"
	@echo ""
	@echo "ðŸ–¥ï¸  Server:"
	@echo "  make server       - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•"
	@echo "  make server-prod  - æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼èµ·å‹•"
	@echo ""
	@echo "ðŸ§ª Testing & Quality:"
	@echo "  make test         - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo "  make lint         - ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯"
	@echo "  make format       - ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ"
	@echo ""
	@echo "ðŸ§¹ Cleanup:"
	@echo "  make clean        - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤"
	@echo "  make clean-all    - å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"

# ä»®æƒ³ç’°å¢ƒãƒã‚§ãƒƒã‚¯
check-venv:
	@if [ ! -d "$(VENV)" ]; then \
		echo "âŒ ä»®æƒ³ç’°å¢ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		echo "ðŸ’¡ ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ 'make setup' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install: check-venv
	@echo "ðŸ“¦ Installing dependencies..."
	$(PIP) install -r requirements.txt

# åˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆä»®æƒ³ç’°å¢ƒã¯æ—¢ã«ä½œæˆæ¸ˆã¿ã‚’å‰æï¼‰
setup: check-venv
	@echo "ðŸš€ Setting up KnestApp Backend..."
	@echo "1ï¸âƒ£ Creating migrations..."
	$(MANAGE) makemigrations users
	$(MANAGE) makemigrations interests  
	$(MANAGE) makemigrations circles
	@echo "2ï¸âƒ£ Applying migrations..."
	$(MANAGE) migrate
	@echo "3ï¸âƒ£ Creating superuser..."
	@echo "Please create a superuser account for admin access:"
	$(MANAGE) createsuperuser
	@echo "âœ… Setup complete! You can now run 'make server'"

# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£
makemigrations: check-venv
	@echo "ðŸ“ Creating migrations..."
	$(MANAGE) makemigrations

migrate: check-venv
	@echo "ðŸ—ƒï¸ Applying migrations..."
	$(MANAGE) migrate

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ
reset-db: check-venv
	@echo "âš ï¸  WARNING: This will delete all data!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	rm -f db.sqlite3
	$(MANAGE) migrate
	@echo "ðŸ—ƒï¸ Database reset complete!"

# Django shell
shell: check-venv
	@echo "ðŸ Starting Django shell..."
	$(MANAGE) shell

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
server: check-venv
	@echo "ðŸ–¥ï¸ Starting development server..."
	@echo "ðŸ“± iOS app should connect to: http://127.0.0.1:8000"
	@echo "ðŸŒ Admin panel: http://127.0.0.1:8000/admin"
	@echo ""
	$(MANAGE) runserver 127.0.0.1:8000

# æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼
server-prod: check-venv
	@echo "ðŸš€ Starting production server..."
	$(MANAGE) runserver 0.0.0.0:8000

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«åŽé›†
collectstatic: check-venv
	@echo "ðŸ“‚ Collecting static files..."
	$(MANAGE) collectstatic --noinput

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test: check-venv
	@echo "ðŸ§ª Running tests..."
	$(MANAGE) test

# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
create-test-data: check-venv
	@echo "ðŸŽ­ Creating test data..."
	$(MANAGE) shell -c "
from apps.users.models import User;
from apps.circles.models import Circle, Category;
from apps.interests.models import Interest;
print('Creating test data...');
# Add your test data creation logic here
print('âœ… Test data created!')
"

# ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆflake8ç­‰ãŒå¿…è¦ï¼‰
lint: check-venv
	@echo "ðŸ” Running code quality checks..."
	@if $(PIP) show flake8 > /dev/null 2>&1; then \
		flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics; \
	else \
		echo "flake8 not installed, skipping..."; \
	fi

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆï¼ˆblackç­‰ãŒå¿…è¦ï¼‰
format: check-venv
	@echo "âœ¨ Formatting code..."
	@if $(PIP) show black > /dev/null 2>&1; then \
		black .; \
	else \
		echo "black not installed, skipping..."; \
	fi

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
clean:
	@echo "ðŸ§¹ Cleaning cache files..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +

# å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean-all: clean
	@echo "ðŸ§¹ Complete cleanup..."
	rm -rf .pytest_cache/
	rm -rf .coverage
	rm -rf htmlcov/

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
backup: check-venv
	@echo "ðŸ’¾ Creating database backup..."
	@if [ -f db.sqlite3 ]; then \
		cp db.sqlite3 "db_backup_$(shell date +%Y%m%d_%H%M%S).sqlite3"; \
		echo "âœ… Backup created!"; \
	else \
		echo "âŒ No database file found"; \
	fi

# ä¾å­˜é–¢ä¿‚ã®æ›´æ–°
update-deps: check-venv
	@echo "ðŸ“¦ Updating dependencies..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt --upgrade

# ãƒ­ã‚°è¡¨ç¤º
logs:
	@echo "ðŸ“‹ Showing logs..."
	@if [ -f logs/django.log ]; then \
		tail -f logs/django.log; \
	else \
		echo "No log file found"; \
	fi

# APIæ–‡æ›¸ç”Ÿæˆ
docs: check-venv
	@echo "ðŸ“š Generating API documentation..."
	@if $(PIP) show django-spectacular > /dev/null 2>&1; then \
		$(MANAGE) spectacular --file schema.yml; \
		echo "âœ… API schema generated: schema.yml"; \
	else \
		echo "django-spectacular not installed, skipping..."; \
	fi 